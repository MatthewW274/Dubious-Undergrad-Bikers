<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bike Network Usability Analysis</title>

  <!-- Calcite -->
  <script type="module" src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"></script>

  <!-- ArcGIS JS API -->
  <script src="https://js.arcgis.com/4.34/"></script>
  <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/light/main.css" />

  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    calcite-shell-panel { --calcite-shell-panel-width: 450px; }

    #TOBikeDiv {
      width: 100%;
      height: calc(100vh - 56px);
      min-height: 500px;
      background: #1f1f1f;
      position: relative;
    }

    calcite-tab-title {
      border-radius: 10px;
      margin: 6px 6px 0 0;
      padding: 10px 12px;
      transition: background 120ms ease, color 120ms ease;
      cursor: pointer;
    }
    calcite-tab-title:hover { background: rgba(255,255,255,0.08); }
    calcite-tab-title[selected] {
      background: rgba(0, 166, 255, 0.18);
      outline: 2px solid rgba(0, 166, 255, 0.65);
    }

    .panel-instructions {
      padding: 14px 15px 10px 15px;
      border-bottom: 1px solid #3a3a3a;
    }
    .panel-instructions h3 {
      margin: 0 0 8px 0;
      font-size: 0.95rem;
      font-weight: 600;
      color: #ffffff;
    }
    .panel-instructions ol {
      margin: 0;
      padding-left: 18px;
      color: #cfcfcf;
      font-size: 0.85rem;
      line-height: 1.35rem;
    }

    .hint { font-size: 0.8rem; color: #b8b8b8; margin: 0 0 10px 0; }

    .meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 10px 0 6px 0;
      padding: 10px 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
    }
    .meta-row strong { font-size: 0.85rem; color: #eaeaea; }
    .total-chip {
      font-weight: 700;
      font-size: 0.9rem;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .row { display: flex; align-items: center; gap: 10px; }
    .spacer { height: 10px; }

    #errorBox {
      display: none;
      margin: 10px 0 12px 0;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 80, 80, 0.5);
      background: rgba(255, 80, 80, 0.12);
      color: #ffd0d0;
      font-size: 0.85rem;
      line-height: 1.25rem;
    }
    #errorBox code {
      color: #ffe3e3;
      font-size: 0.78rem;
      word-break: break-word;
    }

    #toast {
      position: absolute;
      right: 14px;
      top: 14px;
      z-index: 10;
      display: none;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0, 200, 120, 0.18);
      border: 1px solid rgba(0, 200, 120, 0.5);
      color: #d9ffe9;
      font-size: 0.85rem;
      backdrop-filter: blur(6px);
    }
  </style>
</head>

<body class="calcite-mode-dark">
  <calcite-shell>
    <calcite-navigation slot="header">
      <calcite-navigation-logo slot="logo" heading="Bike Network Usability Analysis"></calcite-navigation-logo>
    </calcite-navigation>

    <calcite-shell-panel slot="panel-start" position="start" display-mode="dock">
      <calcite-panel>
        <div class="panel-instructions">
          <h3>How to use this app</h3>
          <ol>
            <li>Select a tab (Safety, Accessibility, Combined).</li>
            <li>Adjust weights so the total equals <b>100</b>.</li>
            <li>Click <b>Calculate</b> to update the map.</li>
          </ol>
        </div>

        <calcite-tabs layout="center">
          <calcite-tab-nav slot="title-group" id="tabNav">
            <calcite-tab-title selected data-map-id="Map1">Safety Index</calcite-tab-title>
            <calcite-tab-title data-map-id="Map2">Accessibility Index</calcite-tab-title>
            <calcite-tab-title data-map-id="Map3">Combined Index</calcite-tab-title>
          </calcite-tab-nav>
        </calcite-tabs>

        <div id="slider-container" style="padding: 15px; border-top: 1px solid #3a3a3a;">
          <div id="errorBox"></div>
        </div>
      </calcite-panel>
    </calcite-shell-panel>

    <div id="TOBikeDiv">
      <div id="toast">Applied ✅</div>
    </div>
  </calcite-shell>

  <script>
    require([
      "esri/config",
      "esri/WebMap",
      "esri/views/MapView",
      "esri/widgets/Legend"
    ], function (esriConfig, WebMap, MapView, Legend) {

      esriConfig.apiKey =
        "AAPTxy8BH1VEsoebNVZXo8HurCrnTmCcEzymprsEAKeawfGPS0RFfE0kmgrw9WWr-y_WZwcGHDTuNfCaNhRm-wNO6uSnNnZ3zn-z19shHJ0kc0b6oAkyBWLGBfDXN4rTrDugcKXMBglAKcEDeqefL5-_lAy2OQlChYA6ZQr_jHBTJHtmTZVKbEue8C7Y3C3hELlLYPONv_z4YxHJOy_3-wEZEOl6awU7HrPRO1ToVJ7aq7-k24oqwTlRo23BLLvV_WILAT1_pyDNUT9t";

      const mapInventory = {
        Map1: {
          id: "a1a2aeb1562f478c816f3a440e0d2812",
          title: "Safety Index",
          factors: [
            { field: "BkColIdxMn", label: "Bike Collisions" },
            { field: "BkThfIdxMn", label: "Bike Theft" },
            { field: "StLtIdxMn", label: "Streetlights" },
            { field: "BkSafIdxMn", label: "Level of Traffic Stress (LTS)" }
          ]
        },
        Map2: {
          id: "a1a2aeb1562f478c816f3a440e0d2812",
          title: "Accessibility Index",
          factors: [
            { field: "BkShrIdxMn", label: "Bikeshare Stations" },
            { field: "BkPrkIdxMn", label: "Bike Parking" },
            { field: "BkSafIdxMn", label: "Level of Traffic Stress (LTS)" }
          ]
        },
        Map3: {
          id: "a1a2aeb1562f478c816f3a440e0d2812",
          title: "Combined Index",
          factors: [
            { key: "Safety", label: "Safety Index (uses your Safety tab weights)" },
            { key: "Access", label: "Accessibility Index (uses your Accessibility tab weights)" },
            { key: "Speed",  label: "Travel Time (Speed)" }
          ]
        }
      };

      const sliderContainer = document.getElementById("slider-container");
      const errorBox = document.getElementById("errorBox");
      const toast = document.getElementById("toast");

      function toastShow() {
        toast.style.display = "block";
        clearTimeout(window.__toastTimer);
        window.__toastTimer = setTimeout(() => toast.style.display = "none", 1100);
      }

      function showError(title, detail) {
        console.error(title, detail);
        errorBox.style.display = "block";
        errorBox.innerHTML = `<b>${title}</b><br/><code>${String(detail)}</code>`;
      }

      function clearError() {
        errorBox.style.display = "none";
        errorBox.innerHTML = "";
      }

      // ✅ NEW: store the last-calculated Safety + Accessibility expressions
      const storedIndex = {
        safetyExpr: null,
        accessExpr: null
      };

      let activeMapId = "Map1";
      let webmap = new WebMap({ portalItem: { id: mapInventory[activeMapId].id } });

      const view = new MapView({
        container: "TOBikeDiv",
        map: webmap
      });

      const legend = new Legend({ view });
      view.ui.add(legend, "bottom-right");

      function getPolylineFeatureLayer() {
        const all = view.map?.allLayers;
        if (!all) return null;

        const candidates = all.toArray().filter(l =>
          l.type === "feature" &&
          (l.geometryType === "polyline" || l.geometryType === "line")
        );
        return candidates[0] || null;
      }

      async function zoomToLayer(layer) {
        try {
          const ext = await layer.queryExtent();
          if (ext && ext.extent) await view.goTo(ext.extent.expand(1.08));
        } catch (e) {
          console.warn("Could not zoom to layer:", e);
        }
      }

      async function ensureLayerReady() {
        await view.when();
        await view.map.when();

        const layer = getPolylineFeatureLayer();
        if (!layer) {
          showError(
            "No polyline FeatureLayer found in the WebMap.",
            "Your WebMap must include the Toronto centrelines/trails polyline layer."
          );
          return null;
        }

        layer.visible = true;
        await layer.load();
        await zoomToLayer(layer);
        clearError();
        return layer;
      }

      function fieldExists(layer, fieldName) {
        return layer.fields?.some(f => f.name === fieldName);
      }

      function clampInt(v, min, max) {
        const n = Number.parseInt(v, 10);
        if (Number.isNaN(n)) return min;
        return Math.max(min, Math.min(max, n));
      }

      function sumValues(sliderLocation) {
        const sliders = sliderLocation.querySelectorAll("calcite-slider");
        let sum = 0;
        sliders.forEach(s => sum += Number(s.value || 0));
        return sum;
      }

      function updateTotalUI(sliderLocation, totalChip, calcBtn, notice) {
        const total = sumValues(sliderLocation);
        totalChip.textContent = `${total} / 100`;

        const ok = (total === 100);
        totalChip.style.background = ok ? "rgba(0, 200, 120, 0.18)" : "rgba(255, 80, 80, 0.18)";
        totalChip.style.borderColor = ok ? "rgba(0, 200, 120, 0.5)" : "rgba(255, 80, 80, 0.5)";
        calcBtn.disabled = !ok;
        notice.open = !ok;
      }

      function buildControls(mapIdKey) {
        const current = mapInventory[mapIdKey];
        sliderContainer.innerHTML = "";
        sliderContainer.appendChild(errorBox);

        const hint = document.createElement("p");
        hint.className = "hint";
        hint.textContent = "Adjust weights. Total must equal 100 to enable Calculate.";
        sliderContainer.appendChild(hint);

        const notice = document.createElement("calcite-notice");
        notice.kind = "danger";
        notice.icon = "exclamation-mark-triangle";
        notice.open = false;
        notice.style.marginBottom = "10px";
        notice.innerHTML = `
          <div slot="title">Weights must total 100</div>
          <div slot="message">Keep adjusting until the total equals exactly 100.</div>
        `;
        sliderContainer.appendChild(notice);

        const meta = document.createElement("div");
        meta.className = "meta-row";
        meta.innerHTML = `<strong>Total weight</strong>`;
        const totalChip = document.createElement("span");
        totalChip.className = "total-chip";
        totalChip.textContent = "0 / 100";
        meta.appendChild(totalChip);
        sliderContainer.appendChild(meta);

        const defaultVal = Math.floor(100 / current.factors.length);

        const calcBtn = document.createElement("calcite-button");
        calcBtn.innerText = "Calculate";
        calcBtn.width = "full";
        calcBtn.style.marginTop = "10px";
        calcBtn.disabled = true;

        current.factors.forEach((factor) => {
          const row = document.createElement("div");
          row.className = "row";

          const label = document.createElement("calcite-label");
          label.layout = "inline-space-between";
          label.style.flex = "1";
          label.innerText = factor.label;

          const input = document.createElement("calcite-input");
          input.type = "number";
          input.min = "0";
          input.max = "100";
          input.step = "1";
          input.value = String(defaultVal);
          input.style.width = "86px";

          const slider = document.createElement("calcite-slider");
          slider.min = 0;
          slider.max = 100;
          slider.value = defaultVal;
          slider.ticks = 25;

          const sync = (val) => {
            const v = clampInt(val, 0, 100);
            slider.value = v;
            input.value = String(v);
            updateTotalUI(sliderContainer, totalChip, calcBtn, notice);
          };

          slider.addEventListener("calciteSliderInput", (e) => sync(e.target.value));
          input.addEventListener("calciteInputInput", (e) => sync(e.target.value));

          row.appendChild(label);
          row.appendChild(input);
          sliderContainer.appendChild(row);
          sliderContainer.appendChild(slider);

          const spacer = document.createElement("div");
          spacer.className = "spacer";
          sliderContainer.appendChild(spacer);
        });

        calcBtn.onclick = () => handleCalculation(mapIdKey);
        sliderContainer.appendChild(calcBtn);

        updateTotalUI(sliderContainer, totalChip, calcBtn, notice);
      }

      // ✅ NEW: build Safety / Accessibility expressions from the weights the user set
      function buildSafetyExpr(weights) {
        return [
          `($feature.BkColIdxMn * ${weights[0]})`,
          `($feature.BkThfIdxMn * ${weights[1]})`,
          `($feature.StLtIdxMn * ${weights[2]})`,
          `($feature.BkSafIdxMn * ${weights[3]})`
        ].join(" + ");
      }

      function buildAccessExpr(weights) {
        return [
          `($feature.BkShrIdxMn * ${weights[0]})`,
          `($feature.BkPrkIdxMn * ${weights[1]})`,
          `($feature.BkSafIdxMn * ${weights[2]})`
        ].join(" + ");
      }

      // ✅ Combined uses stored expressions (from your previous Calculate actions)
      function buildCombinedExpr(weightsCombined) {
        const wSafety = weightsCombined[0];
        const wAccess = weightsCombined[1];
        const wSpeed  = weightsCombined[2];

        // Fallbacks if user hasn’t calculated those tabs yet
        const fallbackSafety = buildSafetyExpr([0.25, 0.25, 0.25, 0.25]);
        const fallbackAccess = buildAccessExpr([0.3333333, 0.3333333, 0.3333333]);

        const safetySub = storedIndex.safetyExpr ? `(${storedIndex.safetyExpr})` : `(${fallbackSafety})`;
        const accessSub = storedIndex.accessExpr ? `(${storedIndex.accessExpr})` : `(${fallbackAccess})`;

        const speedField = `($feature.TvlTmIdxMn)`;

        return `( ${safetySub} * ${wSafety} ) + ( ${accessSub} * ${wAccess} ) + ( ${speedField} * ${wSpeed} )`;
      }

      function applyRenderer(layer, expression) {
        layer.renderer = {
          type: "simple",
          symbol: { type: "simple-line", width: "3.5px" },
          visualVariables: [{
            type: "color",
            valueExpression: expression,
            stops: [
              { value: 1, color: "#228B22", label: "Highest Usability - 1" },
              { value: 3, color: "#FFE700", label: "Moderate Usability - 3" },
              { value: 5, color: "#FF0000", label: "Lowest Usability - 5" }
            ]
          }]
        };
        layer.refresh();
      }

      async function handleCalculation(mapIdKey) {
        const total = sumValues(sliderContainer);
        if (total !== 100) return;

        const layer = await ensureLayerReady();
        if (!layer) return;

        const sliders = sliderContainer.querySelectorAll("calcite-slider");
        const weights = Array.from(sliders).map(s => Number(s.value) / 100);

        const required = (mapIdKey === "Map1")
          ? ["BkColIdxMn", "BkThfIdxMn", "StLtIdxMn", "BkSafIdxMn"]
          : (mapIdKey === "Map2")
            ? ["BkShrIdxMn", "BkPrkIdxMn", "BkSafIdxMn"]
            : ["TvlTmIdxMn","BkColIdxMn","BkThfIdxMn","StLtIdxMn","BkSafIdxMn","BkShrIdxMn","BkPrkIdxMn"];

        const missing = required.filter(f => !fieldExists(layer, f));
        if (missing.length) {
          showError("Missing fields in your feature layer", "Missing: " + missing.join(", "));
          return;
        }

        let expr = "";

        if (mapIdKey === "Map1") {
          expr = buildSafetyExpr(weights);
          storedIndex.safetyExpr = expr; // ✅ STORE for Combined
        } else if (mapIdKey === "Map2") {
          expr = buildAccessExpr(weights);
          storedIndex.accessExpr = expr; // ✅ STORE for Combined
        } else {
          expr = buildCombinedExpr(weights); // ✅ USE stored Safety + Access expressions
        }

        applyRenderer(layer, expr);
        toastShow();
      }

      function setSelectedTab(mapIdKey) {
        const tabs = document.querySelectorAll("calcite-tab-title");
        tabs.forEach(t => t.removeAttribute("selected"));
        const target = Array.from(tabs).find(t => t.getAttribute("data-map-id") === mapIdKey);
        if (target) target.setAttribute("selected", "");
      }

      async function loadTab(mapIdKey) {
        activeMapId = mapIdKey;
        setSelectedTab(mapIdKey);
        buildControls(mapIdKey);

        webmap = new WebMap({ portalItem: { id: mapInventory[mapIdKey].id } });
        view.map = webmap;

        try {
          await webmap.load();
          await ensureLayerReady();
          view.resize();
        } catch (e) {
          showError("WebMap failed to load (private/not shared?)", e?.message || e);
        }
      }

      document.querySelectorAll("calcite-tab-title").forEach((tab) => {
        tab.addEventListener("click", () => {
          const id = tab.getAttribute("data-map-id");
          if (id) loadTab(id);
        });
      });

      view.when(async () => {
        buildControls("Map1");
        await ensureLayerReady();
      });

    });
  </script>
</body>
</html>
